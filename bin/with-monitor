#!/usr/bin/env bash
set -e

SESSION_NAME="${USAGE_MONITOR_SESSION:-monitor-$$}"
HORIZONTAL_PANE_SIZE=20
VERTICAL_PANE_LINES=3

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
if command -v usage-monitor &> /dev/null; then
    MONITOR_CMD="usage-monitor"
elif [[ -f "$SCRIPT_DIR/../dist/cli.js" ]]; then
    MONITOR_CMD="bun run $SCRIPT_DIR/../dist/cli.js"
elif [[ -f "$SCRIPT_DIR/../src/cli/index.ts" ]]; then
    MONITOR_CMD="bun run $SCRIPT_DIR/../src/cli/index.ts"
else
    echo "Error: usage-monitor not found. Run 'bun run build' first." >&2
    exit 1
fi

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTIONS] -- COMMAND [args...]

Run any command with usage monitor in a tmux pane.

OPTIONS:
    -l, --left            put monitor on left (default: right)
    -r, --right           put monitor on right
    -t, --top             put monitor on top
    -b, --bottom          put monitor on bottom
    -s, --session NAME    tmux session name (default: monitor-PID)
    -h, --help            show this help

EXAMPLES:
    $(basename "$0") -- opencode
    $(basename "$0") -- nvim .
    $(basename "$0") -t -- opencode           # monitor on top
    $(basename "$0") -b -- opencode           # monitor on bottom
    $(basename "$0") -l -- zsh                # monitor on left
    $(basename "$0") -s myproject -- opencode

ENVIRONMENT:
    USAGE_MONITOR_SESSION   default session name

REQUIREMENTS:
    - tmux (brew install tmux)
    - bun (curl -fsSL https://bun.sh/install | bash)
EOF
}

POSITION="right"

while [[ $# -gt 0 ]]; do
    case "$1" in
        -l|--left)
            POSITION="left"
            shift
            ;;
        -r|--right)
            POSITION="right"
            shift
            ;;
        -t|--top)
            POSITION="top"
            shift
            ;;
        -b|--bottom)
            POSITION="bottom"
            shift
            ;;
        -s|--session)
            SESSION_NAME="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --)
            shift
            break
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -eq 0 ]]; then
    echo "Error: No command specified." >&2
    echo "" >&2
    usage >&2
    exit 1
fi

MAIN_CMD="$*"

if ! command -v tmux &> /dev/null; then
    echo "Error: tmux is required but not installed." >&2
    echo "" >&2
    echo "Install with:" >&2
    echo "  macOS:  brew install tmux" >&2
    echo "  Ubuntu: sudo apt install tmux" >&2
    echo "  Fedora: sudo dnf install tmux" >&2
    exit 1
fi

if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Session '$SESSION_NAME' already exists. Attaching..." >&2
    exec tmux attach-session -t "$SESSION_NAME"
fi

echo "Starting tmux session: $SESSION_NAME"
echo "  Command: $MAIN_CMD"
echo "  Monitor: ${POSITION}"
echo ""

# Pane naming for easier identification and future toggle support
MAIN_PANE_NAME="main"
MONITOR_PANE_NAME="monitor"

# Wrapper to kill session when main command exits
# This ensures monitor terminates when the main command exits
WRAPPED_CMD="$MAIN_CMD; tmux kill-session -t '$SESSION_NAME' 2>/dev/null || true"

# Create main pane first (use current terminal size to prevent pane redistribution on attach)
tmux new-session -d -s "$SESSION_NAME" -x "$(tput cols)" -y "$(tput lines)" "bash -c '$WRAPPED_CMD'"
tmux select-pane -t "$SESSION_NAME:0.0" -T "$MAIN_PANE_NAME"
tmux set-option -t "$SESSION_NAME" mouse on

# Status bar with exit hint
tmux set-option -t "$SESSION_NAME" status on
tmux set-option -t "$SESSION_NAME" status-style "bg=default,fg=colour245"
tmux set-option -t "$SESSION_NAME" status-left "#[fg=colour75,bold] ${SESSION_NAME} #[default]"
tmux set-option -t "$SESSION_NAME" status-left-length 30
tmux set-option -t "$SESSION_NAME" status-right "#[fg=colour245]Monitor: press q to exit #[default]"
tmux set-option -t "$SESSION_NAME" status-right-length 40

# Determine full monitor command based on position
case "$POSITION" in
    top|bottom) FULL_MONITOR_CMD="$MONITOR_CMD --compact" ;;
    *)          FULL_MONITOR_CMD="$MONITOR_CMD" ;;
esac

# Create wrapper script for monitor pane:
# - Disables echo so keyboard input is not displayed
# - Runs monitor with stdin from /dev/null (display-only)
# - Reads keyboard input: 'q'/'Q' kills the tmux session
MONITOR_WRAPPER="$(mktemp /tmp/usage-monitor.XXXXXX)"
cat > "$MONITOR_WRAPPER" <<ENDWRAPPER
#!/bin/bash
rm -f "${MONITOR_WRAPPER}"
stty raw -echo 2>/dev/null
${FULL_MONITOR_CMD} </dev/null &
MPID=\$!
trap 'kill \$MPID 2>/dev/null' EXIT
while IFS= read -r -n1 key 2>/dev/null; do
    case "\$key" in
        q|Q) tmux kill-session -t "${SESSION_NAME}" 2>/dev/null; exit 0;;
    esac
done
wait \$MPID 2>/dev/null
ENDWRAPPER
chmod +x "$MONITOR_WRAPPER"

# Split based on position
# -h = horizontal split (left/right), -v = vertical split (top/bottom)
# -b = put new pane before (left of / above)
case "$POSITION" in
    left)
        tmux split-window -h -b -t "$SESSION_NAME" -l "${HORIZONTAL_PANE_SIZE}%" "bash '$MONITOR_WRAPPER'"
        tmux select-pane -t "$SESSION_NAME:0.0" -T "$MONITOR_PANE_NAME"
        tmux select-pane -t "$SESSION_NAME:0.1"
        ;;
    right)
        tmux split-window -h -t "$SESSION_NAME" -l "${HORIZONTAL_PANE_SIZE}%" "bash '$MONITOR_WRAPPER'"
        tmux select-pane -t "$SESSION_NAME:0.1" -T "$MONITOR_PANE_NAME"
        tmux select-pane -t "$SESSION_NAME:0.0"
        ;;
    top)
        tmux split-window -v -b -t "$SESSION_NAME" -l "${VERTICAL_PANE_LINES}" "bash '$MONITOR_WRAPPER'"
        tmux select-pane -t "$SESSION_NAME:0.0" -T "$MONITOR_PANE_NAME"
        tmux select-pane -t "$SESSION_NAME:0.1"
        tmux set-hook -t "$SESSION_NAME" window-layout-changed "resize-pane -t '${SESSION_NAME}:0.0' -y ${VERTICAL_PANE_LINES}"
        ;;
    bottom)
        tmux split-window -v -t "$SESSION_NAME" -l "${VERTICAL_PANE_LINES}" "bash '$MONITOR_WRAPPER'"
        tmux select-pane -t "$SESSION_NAME:0.1" -T "$MONITOR_PANE_NAME"
        tmux select-pane -t "$SESSION_NAME:0.0"
        tmux set-hook -t "$SESSION_NAME" window-layout-changed "resize-pane -t '${SESSION_NAME}:0.1' -y ${VERTICAL_PANE_LINES}"
        ;;
esac

# Prevent mouse scroll in monitor pane (cancel copy mode immediately)
tmux set-hook -t "$SESSION_NAME" pane-mode-changed \
    "if -F '#{==:#{pane_title},monitor}' 'send-keys -X cancel'"

exec tmux attach-session -t "$SESSION_NAME"
