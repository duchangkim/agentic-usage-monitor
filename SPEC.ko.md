# Agentic Usage Monitor - 기술 명세서

> **원본 문서**: [English Version](./SPEC.md)
> **주의**: 이 문서는 영어 원본의 번역본입니다. 원본 업데이트 시 이 문서도 함께 업데이트해야 합니다.

## 1. 개요

**Agentic Usage Monitor**는 AI 코딩 에이전트의 사용량과 Rate Limit을 실시간으로 모니터링하는 tmux 기반 도구입니다. 상단 또는 하단에 1~3줄의 컴팩트한 사용량 모니터 페인이 포함된 tmux 세션을 생성하여, 메인 페인에서 AI 코딩 에이전트(OpenCode, Claude Code 등)를 자유롭게 실행하면서 Rate Limit을 지속적으로 모니터링할 수 있습니다.

```
┌──────────────────────────────────────────┐
│  메인 Pane                               │
│  (OpenCode / Claude Code / shell)        │
│                                          │
│                                          │
├──────────────────────────────────────────┤
│ 5h:━━━━━━44% │ 7d:━━12% │ MAX  ↻ 3h12m │  ← 모니터 Pane (1~3줄)
└──────────────────────────────────────────┘
```

### 프로젝트 정보

- **현재 이름**: `opencode-usage-monitor`
- **목표 이름**: `agentic-usage-monitor`
- **CLI 명령어**: `usage-monitor`
- **패키지**: `agentic-usage-monitor` (npm/bun)

## 2. 문제 정의

터미널에서 AI 코딩 에이전트를 사용하는 개발자들이 겪는 문제:

1. **보이지 않는 Rate Limit**: 터미널을 떠나지 않고는 현재 사용량을 알기 어려움
2. **예상치 못한 제한**: 갑자기 Rate Limit에 도달하여 개발 흐름이 끊김
3. **컨텍스트 스위칭**: 사용량 확인을 위해 브라우저/앱으로 전환 필요
4. **일시적 정보**: 사용량 정보가 지속적으로 표시되지 않음

### 현재 해결책의 한계

| 해결책                     | 문제점                          |
| -------------------------- | ------------------------------- |
| claude.ai 설정 페이지 확인 | 브라우저로 컨텍스트 스위칭 필요 |
| Rate Limit 에러 대기       | 반응적, 능동적이지 않음         |
| 직감으로 추정              | 부정확, 불안감 유발             |

## 3. 목표

### 주요 목표

1. **모니터 페인이 포함된 tmux 세션**: 상단 또는 하단에 1~3줄 사용량 모니터 페인이 있는 tmux 세션을 자동 생성
2. **비간섭 모니터링**: 모니터 페인이 메인 터미널 작업을 절대 방해하지 않음 — 최소한의 공간(1~3줄)
3. **한눈에 보는 사용량**: Rate Limit 정보(5시간, 7일 윈도우)를 인지적 부담 없이 즉시 이해 가능하게 표시

### 부가 목표

1. **OpenCode 통합**: OpenCode 플러그인 우선 지원
2. **설정 가능한 배치**: 상/하(1~3줄, 권장 기본값) 및 좌/우(상세 위젯) 포지셔닝
3. **확장 가능한 아키텍처**: 향후 다른 AI 에이전트 지원을 위한 Provider 인터페이스
4. **간편한 설정**: 한 줄 명령으로 설치 및 설정

### 성공 지표

- 터미널을 떠나지 않고 현재 사용량을 한눈에 확인 가능
- 모니터 시작 시간 < 2초
- 새로고침 완료 시간 < 1초
- 모니터 페인이 최소 화면 공간 점유 (상/하 배치 시 1~3줄)
- macOS와 Linux에서 동작

## 4. 비목표 (Non-Goals)

다음 항목은 명시적으로 **범위 외**입니다:

| 비목표                    | 이유                                                  |
| ------------------------- | ----------------------------------------------------- |
| Admin API / 조직 빌링     | 복잡도 감소; 개인 Rate Limit에 집중                   |
| GUI/데스크톱 애플리케이션 | 터미널 네이티브 도구; GUI는 Claude-Usage-Tracker 존재 |
| tmux 외 터미널 멀티플렉서 | tmux가 핵심 의존성; 나머지는 추후 추가 가능           |
| 실시간 토큰 카운팅        | API 호출 인터셉트 필요; 프라이버시 우려               |
| v1에서 멀티 프로바이더    | Claude에 먼저 집중; 아키텍처는 확장 지원              |

## 5. 타겟 사용자

### 주요: OpenCode 사용자

[OpenCode](https://github.com/opencode-ai/opencode)를 터미널 기반 AI 코딩 어시스턴트로 사용하는 개발자.

**특징**:

- 터미널과 tmux에 익숙함
- Claude (Pro/Max) 구독 사용
- Rate Limit의 지속적인 가시성 원함
- 키보드 중심 워크플로우 선호

### 부가: Claude Code 사용자

Anthropic의 공식 Claude Code CLI를 사용하는 개발자.

**참고**: Claude Code 확장은 아키텍처적으로 계획되었으나 v1에서는 우선순위가 낮음.

## 6. 핵심 기능

### 6.1 tmux 세션 관리

**목표**: 한 줄 명령으로 모니터 페인과 메인 작업 공간이 있는 tmux 세션 시작.

**동작 방식**:

1. 메인 페인 + 모니터 페인, 두 개의 페인으로 tmux 세션 생성
2. 모니터 페인은 `usage-monitor` CLI를 컴팩트 모드로 실행 (자동 새로고침)
3. 메인 페인은 사용자의 명령 실행 (OpenCode, Claude Code, shell 등)
4. 메인 명령 종료 시 세션 자동 정리

**페인 배치**:

- **상/하 (권장)**: 1~3줄, 컴팩트 표시 — 주요 사용 사례
- **좌/우**: ~20% 너비, 박스 드로잉이 포함된 상세 위젯 — 더 많은 정보가 필요한 사용자용

**세션 관리**:

- 기존 세션 감지 및 처리 (연결, 종료+재시작, 또는 에러)
- 프로그래밍 제어를 위한 이름 있는 페인 ("main", "monitor")
- 종료 시 깔끔한 정리

### 6.2 Rate Limit 표시

**목표**: 사용자가 현재 Rate Limit 상태를 한눈에 확인할 수 있어야 함.

**필수 정보**:

- 각 Rate Limit 윈도우(5시간, 7일 등)의 현재 사용률 %
- 각 윈도우 리셋까지 남은 시간
- 사용자 프로필 정보 (이름, 조직, 플랜 유형)

**표시 형식**:

- **컴팩트 (1줄)**: `5h:━━━━44% │ 7d:━━12% │ MAX`
- **컴팩트 (3줄)**: 프로필 줄 + 5시간 바 + 7일 바
- **상세 위젯**: 프로필 섹션, 프로그레스 바, 리셋 시간이 포함된 전체 박스

**설계 원칙**: 정보는 인지적 부담 없이 즉시 이해할 수 있어야 함.

### 6.3 표시 모드

#### 컴팩트 Pane (기본)

**목표**: 터미널 상단 또는 하단의 최소 1~3줄 표시.

- 주요이자 권장 모드
- 상/하 포지션일 때 자동 사용
- 시각적 혼란 없이 필수 사용량 정보 표시
- 메인 터미널 작업을 전혀 방해하지 않음

#### 상세 Pane

**목표**: 종합적인 사용량 정보를 위한 전용 공간.

- 좌/우 포지션일 때 사용
- 박스 드로잉, 프로필 정보, 프로그레스 바, 리셋 시간이 포함된 전체 위젯 표시
- 터미널 너비의 ~20%

### 6.4 OpenCode 플러그인

**목표**: 사용자가 OpenCode 내에서 자연스러운 명령으로 모니터를 제어할 수 있어야 함.

**필수 기능**:

- 모니터 가시성 토글 (표시/숨기기)
- 현재 상태 확인
- 설정 도움말 제공

**설계 원칙**: 슬래시 명령과 에이전트에 대한 자연어 요청 모두 동작해야 함.

### 6.5 런처 스크립트

**목표**: 모니터가 미리 설정된 상태로 한 줄 명령으로 시작.

**스크립트**:

- `with-monitor`: 모든 명령에 대한 범용 tmux 런처
- `opencode-with-monitor`: OpenCode 전용 단축 스크립트

**필수 기능**:

- 모니터가 이미 표시된 상태로 모든 명령 시작
- 명령줄 옵션으로 위치 설정 (`-t/--top`, `-b/--bottom`, `-l/--left`, `-r/--right`)
- 기존 세션 충돌을 우아하게 처리

### 6.6 설정

**목표**: 파워 유저를 위한 커스터마이징 옵션과 함께 합리적인 기본값 제공.

**설정 가능 항목**:

- 새로고침 간격
- 표시 위치와 모드
- 시각적 스타일 설정
- 프로필 표시 옵션

**설계 원칙**: 대부분의 사용자에게는 설정 없이 동작해야 함. 기본값: 하단 위치, 컴팩트 모드, 30초 새로고침.

## 7. 아키텍처

### 7.1 시스템 개요

```
┌─────────────────────────────────────────────────────────┐
│                      tmux 세션                            │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌────────────────────────────────────────────────────┐  │
│  │  메인 Pane                                         │  │
│  │  (OpenCode / Claude Code / 모든 터미널 명령)        │  │
│  │                                                    │  │
│  ├────────────────────────────────────────────────────┤  │
│  │  모니터 Pane (1~3줄, 컴팩트)                       │  │
│  │  5h:━━━━━━44% │ 7d:━━12% │ MAX         ↻ 3h12m   │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 7.2 컴포넌트 개요

```
┌────────────────────────────────────────────────────────────┐
│                    agentic-usage-monitor                     │
├────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────┐    ┌──────────────────────────────┐   │
│  │  런처 스크립트     │    │   OpenCode 플러그인           │   │
│  │  (tmux 세션       │    │   (tmux 페인 제어)            │   │
│  │   관리)            │    │                              │   │
│  └────────┬─────────┘    └──────────────┬───────────────┘   │
│           │                              │                   │
│           └──────────┬───────────────────┘                   │
│                      ▼                                       │
│           ┌─────────────────┐    ┌────────────────────────┐  │
│           │   CLI           │    │   Provider 인터페이스   │  │
│           │   (TUI 렌더링,  │───►│                        │  │
│           │    자동 새로고침)│    │   - Claude Provider    │  │
│           └─────────────────┘    │   - 향후 프로바이더     │  │
│                      ▲           └────────────────────────┘  │
│                      │                                       │
│           ┌─────────────────┐                                │
│           │   Monitor Core  │                                │
│           │   (스케줄링,     │                                │
│           │    상태 관리)    │                                │
│           └─────────────────┘                                │
│                                                              │
└────────────────────────────────────────────────────────────┘
```

### 7.3 Provider 인터페이스

**목표**: 대규모 리팩토링 없이 향후 여러 AI 에이전트 프로바이더 지원 가능하게 함.

**설계 원칙**:

- 각 프로바이더는 자체 인증과 API 통신 처리
- 프로바이더와 관계없이 사용량 데이터에 대한 공통 인터페이스
- v1은 Claude만 구현; 가상의 프로바이더를 위한 과도한 설계 지양

### 7.4 데이터 흐름

```
런처 스크립트 → tmux 세션 → 모니터 Pane → CLI 프로세스
                                                │
                                  Config ──► Monitor Core
                                                │
                                  Credentials → Provider → OAuth API
                                                │
                                        Monitor Core → TUI 렌더러 → 터미널 출력
```

## 8. 기술적 제약

### 8.1 요구사항

| 요구사항          | 명세                                 |
| ----------------- | ------------------------------------ |
| 터미널 멀티플렉서 | **tmux (핵심 의존성)**               |
| 런타임            | Bun (Node.js 호환)                   |
| OS                | macOS, Linux                         |
| 인증              | OpenCode/Claude Code OAuth 자격 증명 |

### 8.2 의존성

**설계 원칙**: 의존성 최소화. 꼭 필요한 것만 추가.

| 카테고리    | 패키지              | 용도            |
| ----------- | ------------------- | --------------- |
| 유효성 검사 | zod                 | 설정/응답 검증  |
| 플러그인    | @opencode-ai/plugin | OpenCode 통합   |
| 개발        | typescript, biome   | 타입 체크, 린팅 |

### 8.3 자격 증명 소스

OAuth 자격 증명 우선순위:

1. **OpenCode**: `~/.local/share/opencode/auth.json`
2. **Claude Code**: `~/.claude/.credentials.json`
3. **테스트**: `TEST_CREDENTIALS_PATH` 환경 변수

## 9. 제거된 기능

현재 구현에서 다음 기능들이 **제거**됩니다:

### Admin API 통합

**이유**: 복잡도 감소. 개인 Rate Limit에 집중.

**제거되는 컴포넌트**:

- `src/data/admin-api.ts`
- `--api-only` CLI 플래그
- 조직 빌링/비용 표시
- `ANTHROPIC_ADMIN_API_KEY` 지원

**마이그레이션**: 조직 빌링이 필요한 사용자는 Anthropic Console이나 다른 도구 사용.

## 10. 구현 단계

### Phase 1: 코어 정리 (현재 → v1.0) ✅

- [x] Admin API 컴포넌트 제거
- [x] 설정 단순화 (admin 관련 옵션 제거)
- [x] 문서 업데이트
- [x] 프로젝트 이름 변경: `agentic-usage-monitor`

### Phase 2: tmux 중심 기능 강화 (v1.1)

- [x] 상/하 위치 지원 추가
- [x] 사용하지 않는 widget.width 설정 제거 (pane 크기 고정)
- [x] 상/하 pane용 컴팩트 모드 (1줄 표시)
- [ ] 3줄 컴팩트 모드 (프로필 + 5h + 7d)
- [ ] tmux status bar 통합 추가

### Phase 3: 완성도 개선 (v1.2)

- [ ] 사용량 추이 표시 (선택사항)
- [ ] 테마 커스터마이징
- [ ] 알림 지원 (임계값 알림)

### Phase 4: 확장성 (v2.0)

- [ ] Provider 인터페이스 공식화
- [ ] 프로바이더 추가를 위한 문서
- [ ] 수요가 있으면 OpenAI/Gemini 고려

### Phase 5: 사용자 경험 (v2.1)

- [ ] Pane 크기 기억 (세션 간 리사이즈된 크기 유지)
- [ ] 마우스 리사이즈 후 자동 저장

## 11. 미결정 사항

| 질문                         | 상태 | 참고                        |
| ---------------------------- | ---- | --------------------------- |
| Status bar 포맷 커스터마이징 | TBD  | 얼마나 유연하게?            |
| 멀티 프로바이더 표시         | TBD  | 전부 표시 vs 활성화된 것만? |
| 알림 메커니즘                | TBD  | 터미널 벨? 데스크톱 알림?   |
| 사용량 히스토리/추이         | TBD  | 로컬 저장? 얼마나?          |

## 12. 참고 문서

- [AGENTS.md](./AGENTS.md) - AI 에이전트 지침
- [Claude-Usage-Tracker](https://github.com/hamed-elfayome/Claude-Usage-Tracker) - 참고 macOS 앱
- [OpenCode](https://github.com/opencode-ai/opencode) - 주요 통합 대상

---

**문서 버전**: 1.1
**최종 업데이트**: 2026-02-10
**작성자**: 프로젝트 관리자
